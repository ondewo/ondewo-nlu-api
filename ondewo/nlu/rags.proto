// Copyright 2018 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
// Modifications Copyright 2020-2023 ONDEWO GmbH
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// File-level comment for <code>ondewo/nlu/rags.proto</code>.
//
// This file contains a single service <a href="#ondewo.nlu.Rags">Rags</a>.
//
// The Rags service provides integration with RAGFlow for Retrieval-Augmented Generation (RAG),
// including dataset management, document processing, chunk retrieval, conversational AI with
// chat and agent assistants, and file management. Key message types include <a href="#ondewo.nlu.Dataset">Dataset</a>,
// <a href="#ondewo.nlu.Chat">Chat</a>, and <a href="#ondewo.nlu.Agent">Agent</a>.
syntax = "proto3";

package ondewo.nlu;

import "google/protobuf/struct.proto";
import "google/protobuf/empty.proto";

// ============================================================================
// Common Types
// Shared types used across multiple services.
// ============================================================================

// Pagination parameters for list requests.
message Pagination {
    // Page number (1-indexed, default: 1).
    int32 page = 1;

    // Items per page (default varies by endpoint).
    int32 page_size = 2;
}

// File metadata for streaming uploads/downloads.
message FileMetadata {
    // Filename.
    string file_name = 1;

    // MIME type (e.g., "application/pdf", "image/png").
    string content_type = 2;

    // File size in bytes (if known, 0 if unknown).
    int64 size = 3;
}

// File chunk for streaming downloads.
// First chunk contains metadata, subsequent chunks only contain data.
message FileChunk {
    // Chunk of file content.
    bytes data = 1;

    // File metadata (only in first chunk).
    FileMetadata metadata = 2;
}

// Upload chunk for streaming uploads.
// Used to stream file data after metadata is sent in first message.
message UploadChunk {
    // Not actually optional but `optional` keyword is needed to enable presence tracking.
    // Without it, it is impossible to distinguish between `0` and not present.
    // Index into metadata.files array (0-based).
    optional int32 file_index = 1;

    // Chunk of file content, null indicates EOF.
    bytes data = 2;
}

// On complete success: no fields set (empty message).
// On partial success/failure: both fields set.
message PartialSuccess {
    // Number of successful operations.
    int32 success_count = 1;

    // Error messages for failed operations.
    repeated string errors = 2;
}

// ============================================================================
// Dataset Management Types
// Datasets are knowledge bases containing documents and their chunks.
// ============================================================================

// Dataset (knowledge base) containing documents for RAG.
message Dataset {
    // Dataset UUID.
    string id = 1;

    // Dataset name (required).
    string name = 2;

    // Optional description.
    string description = 3;

    // Base64-encoded avatar image.
    string avatar = 4;

    // Dataset language (e.g., "English").
    string language = 5;

    // Access permission: "me" or "team".
    string permission = 6;

    // Number of documents.
    int32 document_count = 7;

    // Number of chunks (must be 0 to change embedding).
    int32 chunk_count = 8;

    // Chunk/parser method: "naive", "book", "email", "laws", "manual", "one", "paper", "picture", "presentation", "qa", "table", "tag".
    string chunk_method = 9;

    // Parser configuration (auto-generated based on chunk_method).
    google.protobuf.Struct parser_config = 10;

    // Embedding model name (uses tenant default if empty).
    string embedding_model = 11;

    // Creation timestamp (Unix timestamp in milliseconds).
    int64 create_time = 12;

    // Creation date (ISO 8601 datetime).
    string create_date = 13;

    // Last update timestamp (Unix timestamp in milliseconds).
    int64 update_time = 14;

    // Last update date (ISO 8601 datetime).
    string update_date = 15;

    // Number of tokens across all documents.
    int32 token_count = 16;

    // Default similarity threshold (0.0-1.0).
    float similarity_threshold = 17;

    // Default vector similarity weight (0.0-1.0).
    float vector_similarity_weight = 18;

    // Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 19;
}

message CreateDatasetRequest {
    // Required. The agent to create a dataset for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset name.
    string name = 2;

    // Optional. Dataset description.
    string description = 3;

    // Optional. Base64-encoded avatar image.
    string avatar = 4;

    // Optional. Access permission: "me" or "team".
    string permission = 5;

    // Optional. Chunk method: "naive", "book", "email", "laws", "manual", "one", "paper", "picture", "presentation", "qa", "table", "tag".
    string chunk_method = 6;

    // Optional. Parser configuration.
    google.protobuf.Struct parser_config = 7;

    // Optional. Embedding model name (uses tenant default if not specified).
    string embedding_model = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

message UpdateDatasetRequest {
    // Required. The agent to update a dataset for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Optional. New dataset name.
    string name = 3;

    // Optional. New dataset description.
    string description = 4;

    // Optional. New avatar image.
    string avatar = 5;

    // Optional. New access permission.
    string permission = 6;

    // Optional. New chunk method.
    string chunk_method = 7;

    // Optional. New parser config (deep merged with existing).
    google.protobuf.Struct parser_config = 8;

    // Optional. New embedding model (cannot change if chunk_count > 0).
    string embedding_model = 9;

    // Optional. PageRank value (only for elasticsearch).
    int32 pagerank = 10;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 11;
}

message DeleteDatasetsRequest {
    // Required. The agent to delete datasets from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Dataset IDs to delete.
    repeated string ids = 2;

    // Optional. Delete all datasets (needed because protobuf cannot represent ids=null).
    optional bool delete_all = 3;
}

message ListDatasetsRequest {
    // Required. The agent to list all datasets from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Pagination parameters.
    Pagination pagination = 2;

    // Optional. Filter by dataset ID.
    string id = 3;

    // Optional. Filter by dataset name.
    string name = 4;

    // Optional. Sort field (default: "create_time").
    string orderby = 5;

    // Optional. Sort descending (default: true).
    optional bool desc = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

message DatasetList {
    // List of datasets.
    repeated Dataset datasets = 1;
}

message GetKnowledgeGraphRequest {
    // Required. The agent to get knowledge graph for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;
}

message GetKnowledgeGraphResponse {
    google.protobuf.Struct graph = 1;  // Graph structure with nodes (max 256) and edges (max 128): {nodes: [{id, pagerank}], edges: [{source, target, weight}]}
    google.protobuf.Struct mind_map = 2;  // Mind map structure (optional)

    google.protobuf.Struct additional_fields = 3;  // Additional fields to pass through to RAGFlow
}

message DeleteKnowledgeGraphRequest {
    // Required. The agent to delete knowledge graph for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;
}

// ============================================================================
// Document Management Types
// Documents are files uploaded to datasets that are parsed into chunks.
// ============================================================================

// Document uploaded to a dataset.
message Document {
    // Document UUID.
    string id = 1;

    // Parent dataset ID.
    string dataset_id = 2;

    // Document filename.
    string name = 3;

    // File type/extension.
    string type = 4;

    // File size in bytes.
    int64 size = 5;

    // Number of chunks (initially 0).
    int32 chunk_count = 6;

    // Number of tokens.
    int32 token_count = 7;

    // Chunking method for this document.
    string chunk_method = 8;

    // Parser configuration.
    google.protobuf.Struct parser_config = 9;

    // Source type (e.g., "local", "knowledgebase").
    string source_type = 10;

    // Processing status: "UNSTART", "RUNNING", "CANCEL", "DONE", "FAIL".
    string run = 11;

    // Processing progress (0.0 to 1.0).
    float progress = 12;

    // Progress message.
    string progress_msg = 13;

    // Processing duration in seconds.
    float process_duration = 14;

    // Creation timestamp (Unix timestamp in milliseconds).
    int64 create_time = 15;

    // Creation date (ISO 8601 datetime).
    string create_date = 16;

    // Last update timestamp (Unix timestamp in milliseconds).
    int64 update_time = 17;

    // Last update date (ISO 8601 datetime).
    string update_date = 18;

    // Custom metadata fields.
    google.protobuf.Struct meta_fields = 19;

    // Base64-encoded thumbnail image.
    string thumbnail = 20;

    // Storage location path.
    string location = 21;

    // Processing start time.
    string process_begin_at = 22;

    // Real file extension.
    string suffix = 23;

    // Validation status ("0"=invalid, "1"=valid).
    string status = 24;

    // Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 25;
}

// Document upload via streaming multipart form data.
message UploadDocumentsRequest {
    // Required. The agent to upload documents for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Metadata for the upload (first message only).
    message Metadata {
        // Required. Target dataset ID.
        string dataset_id = 1;

        // Required. Metadata for all files being uploaded.
        repeated FileMetadata files = 2;
    }

    // First message must contain metadata, subsequent messages contain chunks.
    oneof payload {
        // First message: declares all files.
        Metadata metadata = 2;

        // Subsequent messages: stream file data.
        UploadChunk chunk = 3;
    }
}

message DocumentList {
    // List of documents.
    repeated Document documents = 1;
}

message UpdateDocumentRequest {
    // Required. The agent to update document for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document ID.
    string document_id = 3;

    // Optional. New document name (file extension must remain same).
    string name = 4;

    // Optional. New chunk method (resets document to UNSTART, deletes chunks).
    string chunk_method = 5;

    // Optional. New parser config (deep merged with existing).
    google.protobuf.Struct parser_config = 6;

    // Optional. Document enabled/disabled status.
    optional bool enabled = 7;

    // Optional. Custom metadata fields (document-specific metadata).
    google.protobuf.Struct meta_fields = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

message DownloadDocumentRequest {
    // Required. The agent to download document from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document ID.
    string document_id = 3;
}

message ListDocumentsRequest {
    // Required. The agent to list documents from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Optional. Pagination parameters.
    Pagination pagination = 3;

    // Optional. Filter by document ID.
    string id = 4;

    // Optional. Filter by document name.
    string name = 5;

    // Optional. Search keywords.
    string keywords = 6;

    // Optional. Sort field (default: "create_time").
    string orderby = 7;

    // Optional. Sort descending (default: true).
    optional bool desc = 8;

    // Optional. Filter by creation time start (Unix timestamp in ms, 0 = no filter).
    int64 create_time_from = 9;

    // Optional. Filter by creation time end (Unix timestamp in ms, 0 = no filter).
    int64 create_time_to = 10;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 11;
}

message ListDocumentsResponse {
    int32 total = 1;  // Total number of documents
    repeated Document docs = 2;  // List of documents
}

message DeleteDocumentsRequest {
    // Required. The agent to delete documents from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Optional. Document IDs to delete.
    repeated string ids = 3;

    // Optional. Delete all documents (needed because protobuf cannot represent ids=null).
    optional bool delete_all = 4;
}

// ============================================================================
// Chunk Management Types
// Chunks are text segments extracted from documents for vector retrieval.
// ============================================================================

// Chunk of text extracted from a document.
message Chunk {
    // Chunk ID (xxhash of content + document_id).
    string id = 1;

    // Parent dataset ID.
    string dataset_id = 2;

    // Parent document ID.
    string document_id = 3;

    // Chunk text content.
    string content = 4;

    // Document name keyword.
    string docnm_kwd = 5;

    // Extracted/provided keywords.
    repeated string important_keywords = 6;

    // Associated questions for Q&A chunks.
    repeated string questions = 7;

    // Associated image ID (if any).
    string image_id = 8;

    // Availability status (can be disabled).
    optional bool available = 9;

    // Position information in original document (array of arrays of 5 integers).
    repeated google.protobuf.ListValue positions = 10;

    // Creation timestamp (ISO 8601).
    string create_time = 11;

    // Creation timestamp as float.
    float create_timestamp = 12;

    // Document name.
    string document_keyword = 13;

    // Similarity score (0.0-1.0).
    float similarity = 14;

    // Embedding vector (optional).
    google.protobuf.Struct vector = 15;

    // Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 16;
}

message ParseDocumentsRequest {
    // Required. The agent to parse documents for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document IDs to parse into chunks (queues for background processing).
    repeated string document_ids = 3;
}

message StopParsingRequest {
    // Required. The agent to stop parsing for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document IDs to stop parsing (only stops actively processing documents).
    repeated string document_ids = 3;
}

message ListChunksRequest {
    // Required. The agent to list chunks from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document ID.
    string document_id = 3;

    // Optional. Pagination parameters.
    Pagination pagination = 4;

    // Optional. Search keywords (supports highlighting in results).
    string keywords = 5;

    // Optional. Filter by specific chunk ID.
    string id = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

message ListChunksResponse {
    int32 total = 1;  // Total number of chunks
    repeated Chunk chunks = 2;  // List of chunks
    Document doc = 3;  // Document details
}

message AddChunkRequest {
    // Required. The agent to add chunk for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document ID.
    string document_id = 3;

    // Required. Chunk content.
    string content = 4;

    // Optional. Important keywords.
    repeated string important_keywords = 5;

    // Optional. Associated questions.
    repeated string questions = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

message AddChunkResponse {
    Chunk chunk = 1;
}

message RemoveChunksRequest {
    // Required. The agent to remove chunks from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document ID.
    string document_id = 3;

    // Required. Chunk IDs to remove.
    repeated string chunk_ids = 4;
}

message UpdateChunkRequest {
    // Required. The agent to update chunk for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID.
    string dataset_id = 2;

    // Required. Document ID.
    string document_id = 3;

    // Required. Chunk ID.
    string chunk_id = 4;

    // Optional. New content (re-tokenizes and re-generates embeddings if changed).
    string content = 5;

    // Optional. Updated keywords.
    repeated string important_keywords = 6;

    // Optional. Updated questions.
    repeated string questions = 7;

    // Optional. Availability status.
    optional bool available = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

message RetrievalRequest {
    // Required. The agent to retrieve chunks for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Pagination parameters.
    Pagination pagination = 2;

    // Required. Dataset IDs to search (must all use same embedding model).
    repeated string dataset_ids = 3;

    // Required. Query string.
    string question = 4;

    // Optional. Filter by document IDs.
    repeated string document_ids = 5;

    // Optional. Minimum similarity score 0.0-1.0 (default: 0.2).
    float similarity_threshold = 6;

    // Optional. Weight for vector similarity vs keyword (default: 0.3).
    float vector_similarity_weight = 7;

    // Optional. Maximum chunks to retrieve before reranking (default: 1024).
    int32 top_k = 8;

    // Optional. Whether to highlight matched content.
    optional bool highlight = 9;

    // Optional. Metadata filter.
    google.protobuf.Struct metadata_condition = 10;

    // Optional. Include knowledge graph retrieval.
    optional bool use_kg = 11;

    // Optional. Cross-language translation.
    repeated string cross_languages = 12;

    // Optional. Extract additional keywords from query.
    optional bool keyword = 13;

    // Optional. Rerank model ID.
    string rerank_id = 14;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 15;
}

message RetrievalResponse {
    repeated Chunk chunks = 1;  // Retrieved chunks with similarity scores
    repeated google.protobuf.Struct doc_aggs = 2;  // Document aggregations
    int32 total = 3;  // Total number of matching chunks

    google.protobuf.Struct additional_fields = 4;  // Additional fields to pass through to RAGFlow
}

// ============================================================================
// Chat Management Types
// Chat assistants are RAG-powered conversational agents.
// ============================================================================

// Chat assistant configuration.
message Chat {
    // Chat UUID.
    string id = 1;

    // Chat name (required, unique).
    string name = 2;

    // Optional description.
    string description = 3;

    // Base64-encoded avatar image.
    string avatar = 4;

    // Dataset IDs (used for requests).
    repeated string dataset_ids = 5;

    // Full dataset objects (used for list responses).
    repeated Dataset datasets = 6;

    // LLM configuration.
    LLMSetting llm = 7;

    // Prompt and retrieval configuration.
    PromptConfig prompt = 8;

    // Creation timestamp (Unix timestamp in milliseconds).
    int64 create_time = 9;

    // Creation date (ISO 8601 datetime).
    string create_date = 10;

    // Last update timestamp (Unix timestamp in milliseconds).
    int64 update_time = 11;

    // Last update date (ISO 8601 datetime).
    string update_date = 12;

    // Reference mode.
    string do_refer = 13;

    // Language setting.
    string language = 14;

    // Prompt type.
    string promt_type = 15;

    // Chat status.
    string status = 16;

    // Tenant ID.
    string tenant_id = 17;

    // Top K setting.
    int32 top_k = 18;

    // Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 19;
}

// LLM configuration for chat assistant.
message LLMSetting {
    string model_name = 1;  // LLM model name (required)
    float temperature = 2;  // Sampling temperature (0.0-2.0)
    float top_p = 3;  // Nucleus sampling parameter (0.0-1.0)
    float frequency_penalty = 4;  // Frequency penalty (-2.0 to 2.0)
    float presence_penalty = 5;  // Presence penalty (-2.0 to 2.0)

    google.protobuf.Struct additional_fields = 6;  // Additional fields to pass through to RAGFlow
}

// Prompt and retrieval configuration for chat assistant.
message PromptConfig {
    string prompt = 1;  // System prompt (RAGFlow provides default)
    repeated PromptVariable variables = 2;  // Prompt template variables
    string opener = 3;  // Opening message
    optional bool show_quote = 4;  // Show quotations from sources
    string empty_response = 5;  // Response when no relevant chunks found
    optional bool tts = 6;  // Text-to-speech enabled
    optional bool refine_multiturn = 7;  // Refine multi-turn conversations
    float similarity_threshold = 8;  // Minimum similarity score for retrieval (0.0-1.0)
    float keywords_similarity_weight = 9;  // Weight for keywords vs vector similarity (0.0-1.0)
    int32 top_n = 10;  // Number of chunks to retrieve
    int32 top_k = 11;  // Maximum chunks before reranking
    string rerank_model = 12;  // Rerank model ID

    google.protobuf.Struct additional_fields = 13;  // Additional fields to pass through to RAGFlow
}

// Prompt template variable.
message PromptVariable {
    string key = 1;  // Variable name
    optional bool optional = 2;  // Whether variable is optional
}

message CreateChatRequest {
    // Required. The agent to create a chat for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat name (must be unique).
    string name = 2;

    // Optional. Chat description.
    string description = 3;

    // Optional. Base64-encoded avatar image.
    string avatar = 4;

    // Required. Datasets to use (must have parsed files, same embedding model).
    repeated string dataset_ids = 5;

    // Optional. LLM configuration.
    LLMSetting llm = 6;

    // Optional. Prompt and retrieval configuration.
    PromptConfig prompt = 7;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 8;
}

message UpdateChatRequest {
    // Required. The agent to update a chat for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat ID.
    string chat_id = 2;

    // Optional. New name (must be unique).
    string name = 3;

    // Optional. New description.
    string description = 4;

    // Optional. New avatar.
    string avatar = 5;

    // Optional. New datasets (must have parsed files, same embedding model).
    repeated string dataset_ids = 6;

    // Optional. New LLM config (merged with existing).
    LLMSetting llm = 7;

    // Optional. New prompt config (merged with existing).
    PromptConfig prompt = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

message DeleteChatsRequest {
    // Required. The agent to delete chats from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Chat IDs to delete.
    repeated string ids = 2;

    // Optional. Delete all chats (needed because protobuf cannot represent ids=null).
    optional bool delete_all = 3;
}

message ListChatsRequest {
    // Required. The agent to list all chats from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Pagination parameters.
    Pagination pagination = 2;

    // Optional. Filter by chat ID.
    string id = 3;

    // Optional. Filter by chat name.
    string name = 4;

    // Optional. Sort field (default: "create_time").
    string orderby = 5;

    // Optional. Sort descending (default: true).
    optional bool desc = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

message ChatList {
    // List of chat assistants (with full datasets).
    repeated Chat chats = 1;
}

// ============================================================================
// Session Management Types
// Sessions are conversation instances for chats and agents.
// ============================================================================

// Session (conversation) for chat assistant
message ChatSession {
    string id = 1;  // Session UUID
    string chat_id = 2;  // Parent chat ID (for chat sessions)
    string name = 3;  // Session name (default: "New session")
    repeated Message messages = 4;  // Message history
    int64 create_time = 6;  // Creation timestamp (Unix timestamp in milliseconds)
    string create_date = 7;  // Creation date (ISO 8601 datetime)
    int64 update_time = 8;  // Last update timestamp (Unix timestamp in milliseconds)
    string update_date = 9;  // Last update date (ISO 8601 datetime)

    google.protobuf.Struct additional_fields = 10;  // Additional fields to pass through to RAGFlow
}

// Message in a session.
message Message {
    string role = 1;  // Message role: "user", "assistant", or "system"
    string content = 2;  // Message content
}

message CreateChatSessionRequest {
    // Required. The agent to create a chat session for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Parent chat ID.
    string chat_id = 2;

    // Optional. Session name (default: "New session").
    string name = 3;

    // Optional. User identifier.
    string user_id = 4;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 5;
}

// Session (conversation) for agent
message AgentSession {
    string id = 1;  // Session UUID
    string agent_id = 2;  // Agent ID
    string user_id = 3;  // User ID
    repeated Message message = 4;  // Message history
    string source = 5;  // Session source
    google.protobuf.Struct dsl = 6;  // Agent DSL configuration
    int64 create_time = 7;  // Creation timestamp (Unix timestamp in milliseconds)
    string create_date = 8;  // Creation date (ISO 8601 datetime)
    int64 update_time = 9;  // Last update timestamp (Unix timestamp in milliseconds)
    string update_date = 10;  // Last update date (ISO 8601 datetime)

    google.protobuf.Struct additional_fields = 11;  // Additional fields to pass through to RAGFlow
}
message CreateAgentSessionRequest {
    // Required. The agent to create an agent session for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Parent agent ID.
    string agent_id = 2;

    // Optional. User ID (defaults to tenant_id).
    string user_id = 3;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 4;
}

message UpdateChatSessionRequest {
    // Required. The agent to update a chat session for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat ID.
    string chat_id = 2;

    // Required. Session ID.
    string session_id = 3;

    // Optional. New session name.
    string name = 4;

    // Optional. User ID.
    string user_id = 5;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 6;
}

message ListChatSessionsRequest {
    // Required. The agent to list all chat sessions from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat ID.
    string chat_id = 2;

    // Optional. Pagination parameters.
    Pagination pagination = 3;

    // Optional. Sort field (default: "create_time").
    string orderby = 4;

    // Optional. Sort descending (default: true).
    optional bool desc = 5;

    // Optional. Filter by session name.
    string name = 6;

    // Optional. Filter by session ID.
    string id = 7;

    // Optional. Filter by user ID.
    string user_id = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

message ChatSessionList {
    repeated ChatSession chat_sessions = 1;  // List of sessions (no pagination metadata)
}

message ListAgentSessionsRequest {
    // Required. The agent to list all agent sessions from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;

    // Optional. Pagination parameters.
    Pagination pagination = 3;

    // Optional. Sort field (default: "update_time").
    string orderby = 4;

    // Optional. Sort descending (default: true).
    optional bool desc = 5;

    // Optional. Filter by session ID.
    string id = 6;

    // Optional. Filter by user ID.
    string user_id = 7;

    // Optional. Include DSL in response.
    optional bool dsl = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

message AgentSessionList {
    repeated AgentSession agent_sessions = 1;  // List of agent sessions (no pagination metadata)
}

message DeleteChatSessionsRequest {
    // Required. The agent to delete chat sessions from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat ID.
    string chat_id = 2;

    // Optional. Session IDs to delete.
    repeated string ids = 3;

    // Optional. Delete all sessions (needed because protobuf cannot represent ids=null).
    optional bool delete_all = 4;
}

message DeleteAgentSessionsRequest {
    // Required. The agent to delete agent sessions from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;

    // Optional. Session IDs to delete.
    repeated string ids = 3;

    // Optional. Delete all sessions (needed because protobuf cannot represent ids=null).
    optional bool delete_all = 4;
}

// ============================================================================
// Completion Types (Streaming)
// Generate responses using RAG and LLMs. All methods support streaming.
// ============================================================================

message ChatCompletionRequest {
    // Required. The agent to generate chat completion for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat assistant ID.
    string chat_id = 2;

    // Optional. Session ID (creates new session if not provided).
    string session_id = 3;

    // Required. User question.
    string question = 4;

    // Optional. Enable streaming (default: true).
    optional bool stream = 5;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 6;
}

// Chat completion response.
// For streaming: each message is one SSE event's data field.
// For non-streaming: single message with complete response.
message ChatCompletionResponse {
    string answer = 1;  // Response text (incremental for streaming, complete for non-streaming)
    google.protobuf.Struct reference = 2;  // Source references (includes chunks array)
    string audio_binary = 3;  // Optional audio response (base64 encoded)
    string id = 4;  // Message ID
    string session_id = 5;  // Session ID
    string prompt = 6;  // Prompt used (usually empty string)
    double created_at = 7;  // Unix timestamp

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 8;
}

// OpenAI-compatible chat completion request.
message OpenAIChatCompletionRequest {
    // Required. The agent to generate chat completion for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat assistant ID.
    string chat_id = 2;

    // Required. Model identifier (required for OpenAI compatibility).
    string model = 3;

    // Required. Conversation history (system/user/assistant messages).
    repeated Message messages = 4;

    // Optional. Enable streaming (default: true).
    optional bool stream = 5;

    // Optional. Include source references (default: false).
    optional bool reference = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

// OpenAI-compatible chat completion response.
// Works for both streaming and non-streaming modes.
// Streaming: each message is one SSE event with delta populated.
// Non-streaming: single message with message populated.
message OpenAIChatCompletionResponse {
    string id = 1;  // Completion ID (format: "chatcmpl-{chat_id}")
    string object = 2;  // "chat.completion.chunk" (streaming) or "chat.completion" (non-streaming)
    int64 created = 3;  // Unix timestamp
    string model = 4;  // Model name
    string system_fingerprint = 5;  // System fingerprint (usually empty string)
    repeated OpenAIChatChoice choices = 6;  // Generated choices
    OpenAIChatUsage usage = 7;  // Token usage (only in final chunk or non-streaming)

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 8;
}

// Choice in OpenAI chat completion response.
message OpenAIChatChoice {
    int32 index = 1;  // Choice index (0-based)
    oneof content {
        OpenAIChatContent message = 2;  // Non-streaming: complete message
        OpenAIChatContent delta = 3;    // Streaming: incremental delta
    }
    string finish_reason = 4;  // "stop", "length", etc. (only in final chunk)
    google.protobuf.Value logprobs = 5;  // Log probabilities (usually null)

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 6;
}

// Message or delta content in OpenAI response.
// For streaming (delta): incremental content, role only in first chunk.
// For non-streaming (message): complete content.
message OpenAIChatContent {
    string role = 1;  // Message role: "assistant" (only in first chunk for streaming)
    string content = 2;  // Incremental (streaming) or complete (non-streaming) content
    string reasoning_content = 3;  // Reasoning from <think>...</think> tags
    google.protobuf.Value function_call = 4;  // Function call (usually null)
    google.protobuf.Value tool_calls = 5;  // Tool calls (usually null)

    // Final chunk fields (only present in last chunk if reference=true)
    google.protobuf.Value reference = 6;  // Source references
    string final_content = 7;  // Complete response text

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 8;
}

// Token usage statistics (OpenAI format).
message OpenAIChatUsage {
    int32 prompt_tokens = 1;  // Number of tokens in prompt
    int32 completion_tokens = 2;  // Number of tokens in completion
    int32 total_tokens = 3;  // Total tokens used

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 8;
}

message AgentCompletionRequest {
    // Required. The agent to generate completion for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;

    // Optional. Session ID (creates new if not provided).
    string session_id = 3;

    // Required. User question.
    string question = 4;

    // Optional. Enable streaming (default: true).
    optional bool stream = 5;

    // Optional. Files to include in agent context.
    repeated File files = 6;

    // Optional. Input form data for agent.
    google.protobuf.Struct inputs = 7;

    // Optional. User identifier.
    string user_id = 8;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 9;
}

// Agent completion response (works for both streaming and non-streaming).
// For streaming: each message is one SSE event with event="message" or "message_end".
// For non-streaming: single message with accumulated content.
message AgentCompletionResponse {
    string event = 1;  // Event type: "message", "message_end", etc.
    string message_id = 2;  // Message ID
    int64 created_at = 3;  // Creation timestamp
    string task_id = 4;  // Task ID
    AgentCompletionData data = 5;  // Event data
    string session_id = 6;  // Session ID

    google.protobuf.Struct additional_fields = 7;  // Additional fields from RAGFlow response
}

// Data payload in agent completion response.
message AgentCompletionData {
    string content = 1;  // Incremental (streaming) or complete (non-streaming) content
    google.protobuf.Struct inputs = 2;  // Input data
    google.protobuf.Struct outputs = 3;  // Output data
    google.protobuf.Struct reference = 4;  // Source references

    google.protobuf.Struct additional_fields = 5;  // Additional fields from RAGFlow response
}

// OpenAI-compatible agent completion request.
message OpenAIAgentCompletionRequest {
    // Required. The agent to generate completion for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;

    // Required. Model identifier.
    string model = 3;

    // Required. Conversation history (filters to user/assistant only).
    repeated Message messages = 4;

    // Optional. Enable streaming (default: true).
    optional bool stream = 5;

    // Optional. Session ID (can be in metadata.id).
    string session_id = 6;

    // Optional. ID field.
    string id = 7;

    // Optional. Additional fields to pass through to RAGFlow (e.g., temperature, max_tokens, id, metadata).
    google.protobuf.Struct additional_fields = 8;
}

// ============================================================================
// Agent Management Types
// Agents are workflow-based AI assistants with DSL configuration.
// ============================================================================

// Agent (workflow-based AI assistant).
message Agent {
    // Agent UUID.
    string id = 1;

    // Agent title (must be unique).
    string title = 2;

    // Optional description.
    string description = 3;

    // Base64-encoded avatar image.
    string avatar = 4;

    // DSL (Domain Specific Language) configuration for agent workflow.
    google.protobuf.Struct dsl = 5;

    // Creation timestamp (Unix timestamp in milliseconds).
    int64 create_time = 6;

    // Creation date (ISO 8601 datetime).
    string create_date = 7;

    // Last update timestamp (Unix timestamp in milliseconds).
    int64 update_time = 8;

    // Last update date (ISO 8601 datetime).
    string update_date = 9;

    // Owner user ID.
    string user_id = 10;

    // Canvas type.
    string canvas_type = 11;

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 12;
}

message CreateAgentRequest {
    // Required. The agent to create a RAGFlow agent for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent title (must be unique).
    string title = 2;

    // Optional. Agent description.
    string description = 3;

    // Required. DSL configuration (creates version snapshot).
    google.protobuf.Struct dsl = 4;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 5;
}

message UpdateAgentRequest {
    // Required. The agent to update a RAGFlow agent for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;

    // Optional. New title (must be unique).
    string title = 3;

    // Optional. New description.
    string description = 4;

    // Optional. New DSL (creates version snapshot, only owner can update).
    google.protobuf.Struct dsl = 5;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 6;
}

message DeleteAgentRequest {
    // Required. The agent to delete a RAGFlow agent from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID (only owner can delete).
    string agent_id = 2;
}

message ListAgentsRequest {
    // Required. The agent to list all RAGFlow agents from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Pagination parameters.
    Pagination pagination = 2;

    // Optional. Filter by agent title.
    string title = 3;

    // Optional. Sort field (default: "update_time").
    string orderby = 4;

    // Optional. Sort descending (default: true).
    optional bool desc = 5;

    // Optional. Filter by agent ID.
    string id = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

message AgentList {
    // List of user's own agents (no pagination metadata).
    repeated Agent agents = 1;
}

// ============================================================================
// File Management Types
// Files and folders in RAGFlow's file system. Can be converted to documents.
// ============================================================================

// File or folder in RAGFlow file system.
message File {
    // File/folder UUID.
    string id = 1;

    // File/folder name.
    string name = 2;

    // File type/extension or "folder" (check type == "folder" for directories).
    string type = 3;

    // File size in bytes (0 for folders).
    int64 size = 4;

    // Parent folder ID.
    string parent_id = 5;

    // Creation timestamp (Unix timestamp in milliseconds).
    int64 create_time = 6;

    // Creation date (ISO 8601 datetime).
    string create_date = 7;

    // Last update timestamp (Unix timestamp in milliseconds).
    int64 update_time = 8;

    // Last update date (ISO 8601 datetime).
    string update_date = 9;

    // Storage location path.
    string location = 10;

    // Source type.
    string source_type = 11;

    // Additional fields from RAGFlow response.
    google.protobuf.Struct additional_fields = 12;
}

// File upload via streaming multipart form data.
message UploadFilesRequest {
    // Required. The agent to upload files for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Metadata for the upload (first message only).
    message Metadata {
        // Optional. Parent folder ID (uses root if not provided).
        string parent_id = 1;

        // Required. Metadata for all files being uploaded.
        repeated FileMetadata files = 2;
    }

    // First message must contain metadata, subsequent messages contain chunks.
    oneof payload {
        // First message: declares all files.
        Metadata metadata = 2;

        // Subsequent messages: stream file data.
        UploadChunk chunk = 3;
    }
}

message FileList {
    repeated File files = 1;  // Uploaded files (auto-creates intermediate folders)
}

message CreateFileRequest {
    // Required. The agent to create a file for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File or folder name.
    string name = 2;

    // Optional. Parent folder ID (uses root if not provided).
    string parent_id = 3;

    // Required. Either "folder" or "virtual".
    string type = 4;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 5;
}

message ListFilesRequest {
    // Required. The agent to list files from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Optional. Folder ID to list (uses root if not provided).
    string parent_id = 2;

    // Optional. Pagination parameters (default page size: 15).
    Pagination pagination = 3;

    // Optional. Search keywords.
    string keywords = 4;

    // Optional. Sort field (default: "create_time").
    string orderby = 5;

    // Optional. Sort descending (default: true).
    optional bool desc = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

message ListFilesResponse {
    int32 total = 1;  // Total number of files
    repeated File files = 2;  // List of files and folders
    File parent_folder = 3;  // Parent folder information
}

message GetRootFolderResponse {
    File root_folder = 1;
}

message GetParentFolderResponse {
    File parent_folder = 1;
}

message GetAllParentFoldersResponse {
    repeated File parent_folders = 1;
}

// Request message for GetParentFolder operation.
message GetParentFolderRequest {
    // Required. The agent to get parent folder for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File ID.
    string file_id = 2;
}

// Request message for GetAllParentFolders operation.
message GetAllParentFoldersRequest {
    // Required. The agent to get all parent folders for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File ID.
    string file_id = 2;
}

// Request message for GetFile operation.
message GetFileRequest {
    // Required. The agent to get file from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File ID.
    string file_id = 2;
}

// Deprecated: Use GetParentFolderRequest, GetAllParentFoldersRequest, or GetFileRequest instead.
message FileID {
    // File ID (required).
    string file_id = 1;
}

message DeleteFilesRequest {
    // Required. The agent to delete files from.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File IDs to delete.
    repeated string file_ids = 2;
}

message RenameFileRequest {
    // Required. The agent to rename a file for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File ID.
    string file_id = 2;

    // Required. New name (file extension must remain same).
    string name = 3;
}

message MoveFileRequest {
    // Required. The agent to move files for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File IDs to move.
    repeated string src_file_ids = 2;

    // Required. Destination folder ID.
    string dest_file_id = 3;
}

message FileToDocumentRequest {
    // Required. The agent to convert files to documents for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. File IDs (handles folders recursively).
    repeated string file_ids = 2;

    // Required. Target dataset IDs (can link to multiple).
    repeated string kb_ids = 3;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 4;
}

// File to document association
message FileToDocument {
    string id = 1;  // Association ID
    string file_id = 2;  // File ID
    string document_id = 3;  // Document ID
    int64 create_time = 4;  // Creation timestamp (Unix timestamp in milliseconds)
    string create_date = 5;  // Creation date (ISO 8601 datetime)
    int64 update_time = 6;  // Last update timestamp (Unix timestamp in milliseconds)
    string update_date = 7;  // Last update date (ISO 8601 datetime)

    google.protobuf.Struct additional_fields = 8;  // Additional fields to pass through to RAGFlow
}

message FileToDocumentList {
    repeated FileToDocument filesToDocuments = 1;  // File-to-document associations
}

// ============================================================================
// Dify Integration Types
// Integration with Dify platform (uses API key authentication).
// ============================================================================

message DifyRetrievalRequest {
    // Required. The agent to retrieve dify data for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID (called "knowledge_id" in Dify format).
    string knowledge_id = 2;

    // Required. Search query.
    string query = 3;

    // Optional. Retrieval settings (nested object).
    DifyRetrievalSetting retrieval_setting = 4;

    // Optional. Metadata filter.
    google.protobuf.Struct metadata_condition = 5;

    // Optional. Use knowledge graph.
    optional bool use_kg = 6;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 7;
}

// Dify retrieval settings.
message DifyRetrievalSetting {
    float score_threshold = 1;  // Minimum score (default: 0.0)
    int32 top_k = 2;  // Maximum results (default: 1024)

    google.protobuf.Struct additional_fields = 3;  // Additional fields to pass through to RAGFlow
}

message DifyRecordList {
    repeated DifyRecord records = 1;  // Retrieved records in Dify-compatible format
}

// Dify-compatible record structure.
message DifyRecord {
    string content = 1;  // Chunk content
    float score = 2;  // Similarity score
    string title = 3;  // Document title
    google.protobuf.Struct metadata = 4;  // Additional metadata

    google.protobuf.Struct additional_fields = 5;  // Additional fields to pass through to RAGFlow
}

// ============================================================================
// Bot API Types
// ============================================================================

message AskRequest {
    // Required. The agent to ask question for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. User question.
    string question = 2;

    // Required. Dataset IDs to search.
    repeated string dataset_ids = 3;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 4;
}

message AskResponse {
    string answer = 1;  // Generated answer (streaming only)
    google.protobuf.Struct reference = 2;  // Source references

    google.protobuf.Struct additional_fields = 3;  // Additional fields to pass through to RAGFlow
}

message RelatedQuestionsRequest {
    // Required. The agent to get related questions for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. User question.
    string question = 2;

    // Optional. Industry context.
    string industry = 3;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 4;
}

message RelatedQuestionsResponse {
    repeated string questions = 1;  // 5-10 related question suggestions
}

message ChatbotCompletionRequest {
    // Required. The agent to generate chatbot completion for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat dialog ID.
    string dialog_id = 2;

    // Required. User question.
    string question = 3;

    // Optional. Enable streaming (default: true).
    optional bool stream = 4;

    // Optional. Session ID.
    string session_id = 5;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 6;
}

message ChatbotInfoRequest {
    // Required. The agent to get chatbot info for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Chat dialog ID.
    string dialog_id = 2;
}

message ChatbotInfoResponse {
    string title = 1;  // Chat name (for UI initialization)
    string avatar = 2;  // Chat avatar
    string prologue = 3;  // Opening message
}

message AgentbotCompletionRequest {
    // Required. The agent to generate agentbot completion for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;

    // Required. User question.
    string question = 3;

    // Optional. Enable streaming (default: true).
    optional bool stream = 4;

    // Optional. Session ID.
    string session_id = 5;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 6;
}

message AgentbotInputsRequest {
    // Required. The agent to get agentbot inputs for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Agent ID.
    string agent_id = 2;
}

message AgentbotInputsResponse {
    string title = 1;  // Agent title
    string avatar = 2;  // Agent avatar
    repeated google.protobuf.Struct inputs = 3;  // Input form configuration from "begin" component in DSL
    string prologue = 4;  // Opening message
    string mode = 5;  // Agent mode
}

message SearchbotAskRequest {
    // Required. The agent to ask searchbot question for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. User question.
    string question = 2;

    // Required. Datasets to search (called kb_ids internally).
    repeated string kb_ids = 3;

    // Optional. Search app ID (loads search app config).
    string search_id = 4;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 5;
}

message SearchbotRetrievalRequest {
    // Required. The agent to retrieve searchbot results for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Dataset ID(s) - string or array (called dataset_ids in response).
    repeated string kb_id = 2;

    // Required. Query string.
    string question = 3;

    // Optional. Page number (default: 1).
    int32 page = 4;

    // Optional. Page size (default: 30).
    int32 size = 5;

    // Optional. Filter by document IDs.
    repeated string doc_ids = 6;

    // Optional. Minimum similarity (default: 0.0).
    float similarity_threshold = 7;

    // Optional. Vector vs keyword weight (default: 0.3).
    float vector_similarity_weight = 8;

    // Optional. Use knowledge graph.
    optional bool use_kg = 9;

    // Optional. Maximum results before reranking (default: 1024).
    int32 top_k = 10;

    // Optional. Cross-language translation (called langs internally).
    repeated string cross_languages = 11;

    // Optional. Extract additional keywords.
    optional bool keyword = 12;

    // Optional. Rerank model ID.
    string rerank_id = 13;

    // Optional. Search app ID (loads metadata filters).
    string search_id = 14;

    // Optional. Highlight matched content.
    optional bool highlight = 15;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 16;
}

message SearchbotRetrievalResponse {
    repeated Chunk chunks = 1;  // Retrieved chunks with similarity scores
    repeated google.protobuf.Struct doc_aggs = 2;  // Document aggregations
    int32 total = 3;  // Total number of matching chunks
    repeated string labels = 4;  // Labels

    google.protobuf.Struct additional_fields = 5;  // Additional fields to pass through to RAGFlow
}

message SearchbotRelatedQuestionsRequest {
    // Required. The agent to get searchbot related questions for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. User question.
    string question = 2;

    // Optional. Search app ID (loads LLM config).
    string search_id = 3;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 4;
}

message SearchbotDetailRequest {
    // Required. The agent to get searchbot detail for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. Search app ID.
    string search_id = 2;
}

message SearchbotDetailResponse {
    string id = 1;  // Search app ID
    string avatar = 2;  // Search app avatar
    string tenant_id = 3;  // Tenant ID
    string name = 4;  // Search app name
    string description = 5;  // Search app description
    string create_by = 6;  // Creator ID
    google.protobuf.Struct search_config = 7;  // Search configuration
    int64 update_time = 8;  // Last update timestamp (Unix timestamp in milliseconds)
    string nickname = 9;  // Creator nickname
    string tenant_avatar = 10;  // Tenant avatar

    google.protobuf.Struct additional_fields = 11;  // Additional fields to pass through to RAGFlow
}

message SearchbotMindmapRequest {
    // Required. The agent to generate searchbot mindmap for.
    // Format: <pre><code>TODO_SPECIFY_RESOURCE_PATH_FORMAT</code></pre>
    string parent = 1;

    // Required. User question.
    string question = 2;

    // Required. Dataset IDs.
    repeated string kb_ids = 3;

    // Optional. Search app ID (loads search app config).
    string search_id = 4;

    // Optional. Additional fields to pass through to RAGFlow.
    google.protobuf.Struct additional_fields = 5;
}

message SearchbotMindmapResponse {
    google.protobuf.Struct mindmap = 1;  // Generated mindmap structure
}

// RAGFlow gRPC Service
// Provides async gRPC interface to RAGFlow SDK API endpoints.
service Rags {
    // ========================================================================
    // Dataset Management (6 methods)
    // REST: /api/v1/datasets
    // ========================================================================

    // Create a new dataset (knowledge base).
    // Uses tenant's default embedding model if not specified.
    // REST: POST /api/v1/datasets
        rpc CreateDataset(CreateDatasetRequest) returns (Dataset);

    // Update an existing dataset's configuration.
    // Cannot change embedding_model if dataset has chunks.
    // REST: PUT /api/v1/datasets/<dataset_id>
        rpc UpdateDataset(UpdateDatasetRequest) returns (Dataset);

    // Delete one or more datasets (batch operation).
    // If ids is null or empty, deletes all user's datasets.
    // Deletes all associated documents, files, and chunks.
    // REST: DELETE /api/v1/datasets
        rpc DeleteDatasets(DeleteDatasetsRequest) returns (PartialSuccess);

    // List datasets with pagination and filtering.
    // Returns datasets from all tenants the user has access to.
    // REST: GET /api/v1/datasets
        rpc ListDatasets(ListDatasetsRequest) returns (DatasetList);

    // Get the knowledge graph for a dataset.
    // Returns graph structure with nodes (max 256) and edges (max 128).
    // REST: GET /api/v1/datasets/<dataset_id>/knowledge_graph
        rpc GetKnowledgeGraph(GetKnowledgeGraphRequest) returns (GetKnowledgeGraphResponse);

    // Delete the knowledge graph for a dataset.
    // Deletes graph-related chunks but not the dataset itself.
    // REST: DELETE /api/v1/datasets/<dataset_id>/knowledge_graph
        rpc DeleteKnowledgeGraph(DeleteKnowledgeGraphRequest) returns (google.protobuf.Empty);

    // ========================================================================
    // Document Management (5 methods)
    // REST: /api/v1/datasets/<dataset_id>/documents
    // ========================================================================

    // Upload one or more documents to a dataset.
    // Documents start in UNSTART state and must be parsed.
    // REST: POST /api/v1/datasets/<dataset_id>/documents
        rpc UploadDocuments(stream UploadDocumentsRequest) returns (DocumentList);

    // Update document metadata and configuration.
    // Changing chunk_method resets document to UNSTART and deletes chunks.
    // REST: PUT /api/v1/datasets/<dataset_id>/documents/<document_id>
        rpc UpdateDocument(UpdateDocumentRequest) returns (Document);

    // Download the original document file.
    // Returns binary file stream from storage.
    // First chunk contains metadata, subsequent chunks only contain data.
    // REST: GET /api/v1/datasets/<dataset_id>/documents/<document_id>
        rpc DownloadDocument(DownloadDocumentRequest) returns (stream FileChunk);

    // List documents in a dataset with pagination and filtering.
    // Supports time range filtering and keyword search.
    // REST: GET /api/v1/datasets/<dataset_id>/documents
        rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);

    // Delete one or more documents from a dataset (batch operation).
    // If ids empty, deletes all documents. Removes chunks and storage files.
    // REST: DELETE /api/v1/datasets/<dataset_id>/documents
        rpc DeleteDocuments(DeleteDocumentsRequest) returns (PartialSuccess);

    // ========================================================================
    // Chunk Management (7 methods)
    // Chunks are text segments extracted from documents for retrieval.
    // REST: /api/v1/datasets/<dataset_id>/chunks
    // ========================================================================

    // Start parsing documents into chunks.
    // Cannot parse documents currently being processed (0 < progress < 1).
    // Queues documents for background processing.
    // REST: POST /api/v1/datasets/<dataset_id>/chunks
        rpc ParseDocuments(ParseDocumentsRequest) returns (PartialSuccess);

    // Stop parsing documents.
    // Can only stop documents with progress between 0 and 1.
    // REST: DELETE /api/v1/datasets/<dataset_id>/chunks
        rpc StopParsing(StopParsingRequest) returns (PartialSuccess);

    // List chunks of a document with pagination.
    // Supports keyword search with content highlighting.
    // REST: GET /api/v1/datasets/<dataset_id>/documents/<document_id>/chunks
        rpc ListChunks(ListChunksRequest) returns (ListChunksResponse);

    // Manually add a chunk to a document.
    // Automatically tokenizes content and generates embeddings.
    // REST: POST
    // /api/v1/datasets/<dataset_id>/documents/<document_id>/chunks
        rpc AddChunk(AddChunkRequest) returns (AddChunkResponse);

    // Remove one or more chunks from a document.
    // If chunk_ids empty, removes all chunks from document.
    // REST: DELETE
    // /api/v1/datasets/<dataset_id>/documents/<document_id>/chunks
        rpc RemoveChunks(RemoveChunksRequest) returns (PartialSuccess);

    // Update an existing chunk's content and metadata.
    // Re-tokenizes content and re-generates embeddings if content changed.
    // REST: PUT
    // /api/v1/datasets/<dataset_id>/documents/<document_id>/chunks/<chunk_id>
        rpc UpdateChunk(UpdateChunkRequest) returns (google.protobuf.Empty);

    // Retrieve chunks using vector similarity search.
    // All datasets must use the same embedding model.
    // Supports reranking, metadata filtering, and knowledge graph retrieval.
    // REST: POST /api/v1/retrieval
        rpc Retrieval(RetrievalRequest) returns (RetrievalResponse);

    // ========================================================================
    // Chat Management (4 methods)
    // Chat assistants are RAG-powered conversational agents.
    // REST: /api/v1/chats
    // ========================================================================

    // Create a new chat assistant.
    // All datasets must have parsed files (chunk_num > 0).
    // All datasets must use the same embedding model.
    // REST: POST /api/v1/chats
        rpc CreateChat(CreateChatRequest) returns (Chat);

    // Update an existing chat assistant's configuration.
    // LLM and prompt configs are merged with existing values.
    // REST: PUT /api/v1/chats/<chat_id>
        rpc UpdateChat(UpdateChatRequest) returns (google.protobuf.Empty);

    // Delete one or more chat assistants (batch operation).
    // If ids empty, deletes all user's chats (soft delete).
    // REST: DELETE /api/v1/chats
        rpc DeleteChats(DeleteChatsRequest) returns (PartialSuccess);

    // List chat assistants with pagination.
    // Returns full dataset objects (not just IDs).
    // REST: GET /api/v1/chats
        rpc ListChats(ListChatsRequest) returns (ChatList);

    // ========================================================================
    // Session Management (7 methods)
    // Sessions are conversation instances for chats and agents.
    // REST: /api/v1/chats/<chat_id>/sessions,
    // /api/v1/agents/<agent_id>/sessions
    // ========================================================================

    // Create a new chat session (conversation).
    // Session initialized with assistant's prologue message.
    // REST: POST /api/v1/chats/<chat_id>/sessions
        rpc CreateChatSession(CreateChatSessionRequest) returns (ChatSession);

    // Create a new agent session.
    // Initializes Canvas with agent's DSL configuration.
    // REST: POST /api/v1/agents/<agent_id>/sessions
        rpc CreateAgentSession(CreateAgentSessionRequest) returns (AgentSession);

    // Update a chat session's metadata (name only).
    // Cannot update message or reference fields.
    // REST: PUT /api/v1/chats/<chat_id>/sessions/<session_id>
        rpc UpdateChatSession(UpdateChatSessionRequest) returns (google.protobuf.Empty);

    // List sessions for a chat assistant.
    // Returns message history with embedded chunk references.
    // REST: GET /api/v1/chats/<chat_id>/sessions
        rpc ListChatSessions(ListChatSessionsRequest) returns (ChatSessionList);

    // List sessions for an agent.
    // Can optionally exclude DSL from response for performance.
    // REST: GET /api/v1/agents/<agent_id>/sessions
        rpc ListAgentSessions(ListAgentSessionsRequest) returns (AgentSessionList);

    // Delete one or more chat sessions (batch operation).
    // If ids empty, deletes all sessions for the chat (hard delete).
    // REST: DELETE /api/v1/chats/<chat_id>/sessions
        rpc DeleteChatSessions(DeleteChatSessionsRequest) returns (PartialSuccess);

    // Delete one or more agent sessions (batch operation).
    // If ids empty, deletes all sessions for the agent (hard delete).
    // REST: DELETE /api/v1/agents/<agent_id>/sessions
        rpc DeleteAgentSessions(DeleteAgentSessionsRequest) returns (PartialSuccess);

    // ========================================================================
    // Completion (4 streaming methods)
    // Generate responses using RAG and LLMs.
    // All methods support server-side streaming.
    // REST: /api/v1/chats/<id>/completions,
    // /api/v1/agents/<id>/completions
    // ========================================================================

    // Generate chat completion with RAG (server streaming).
    // Creates new session if session_id not provided.
    // REST: POST /api/v1/chats/<chat_id>/completions
        rpc ChatCompletion(ChatCompletionRequest) returns (stream ChatCompletionResponse);

    // OpenAI-compatible chat completion endpoint (server streaming).
    // Compatible with OpenAI Python client.
    // Supports reasoning content in <think> tags.
    // REST: POST /api/v1/chats_openai/<chat_id>/chat/completions
        rpc OpenAIChatCompletion(OpenAIChatCompletionRequest) returns (stream OpenAIChatCompletionResponse);

    // Generate agent completion (server streaming).
    // Filters events to only return message-related events.
    // REST: POST /api/v1/agents/<agent_id>/completions
        rpc AgentCompletion(AgentCompletionRequest) returns (stream AgentCompletionResponse);

    // OpenAI-compatible agent completion endpoint (server streaming).
    // Uses tiktoken for token counting.
    // REST: POST /api/v1/agents_openai/<agent_id>/chat/completions
        rpc OpenAIAgentCompletion(OpenAIAgentCompletionRequest) returns (stream OpenAIChatCompletionResponse);

    // ========================================================================
    // Agent Management (4 methods)
    // Agents are workflow-based AI assistants with DSL configuration.
    // REST: /api/v1/agents
    // ========================================================================

    // Create a new agent with DSL configuration.
    // Title must be unique for the user.
    // REST: POST /api/v1/agents
        rpc CreateAgent(CreateAgentRequest) returns (google.protobuf.Empty);

    // Update an existing agent.
    // DSL updates create new version snapshot. Only owner can update.
    // REST: PUT /api/v1/agents/<agent_id>
        rpc UpdateAgent(UpdateAgentRequest) returns (google.protobuf.Empty);

    // Delete an agent (hard delete).
    // Only owner can delete.
    // REST: DELETE /api/v1/agents/<agent_id>
        rpc DeleteAgent(DeleteAgentRequest) returns (google.protobuf.Empty);

    // List agents with pagination.
    // Only returns user's own agents.
    // REST: GET /api/v1/agents
        rpc ListAgents(ListAgentsRequest) returns (AgentList);

    // ========================================================================
    // File Management (11 methods)
    // Manage files and folders in RAGFlow's file system.
    // Files can be converted to dataset documents.
    // REST: /api/v1/file/*
    // ========================================================================

    // Upload one or more files via multipart form data.
    // Supports nested folder paths in filename.
    // Auto-creates intermediate folders.
    // REST: POST /api/v1/file/upload
        rpc UploadFiles(stream UploadFilesRequest) returns (FileList);

    // Create a new folder.
    // Duplicate names in same folder not allowed.
    // REST: POST /api/v1/file/create
        rpc CreateFile(CreateFileRequest) returns (File);

    // List files in a folder with pagination.
    // Supports keyword search. Auto-initializes knowledgebase docs folder.
    // REST: GET /api/v1/file/list
        rpc ListFiles(ListFilesRequest) returns (ListFilesResponse);

    // Get user's root folder information.
    // Each tenant has a unique root folder.
    // REST: GET /api/v1/file/root_folder
        rpc GetRootFolder(google.protobuf.Empty) returns (GetRootFolderResponse);

    // Get the parent folder of a file.
    // Returns 404 if file or parent not found.
    // REST: GET /api/v1/file/parent_folder
        rpc GetParentFolder(GetParentFolderRequest) returns (GetParentFolderResponse);

    // Get all parent folders (breadcrumb path) of a file.
    // Returns array from file itself to root (includes the file, ordered deepest to root).
    // REST: GET /api/v1/file/all_parent_folder
        rpc GetAllParentFolders(GetAllParentFoldersRequest) returns (GetAllParentFoldersResponse);

    // Delete one or more files/folders (hard delete).
    // Recursively deletes folder contents. Removes from storage.
    // REST: POST /api/v1/file/rm
        rpc DeleteFiles(DeleteFilesRequest) returns (google.protobuf.Empty);

    // Rename a file or folder.
    // Cannot change file extension. Duplicate names not allowed.
    // REST: POST /api/v1/file/rename
        rpc RenameFile(RenameFileRequest) returns (google.protobuf.Empty);

    // Download a file.
    // Retrieves from MinIO/S3 storage.
    // First chunk contains metadata, subsequent chunks only contain data.
    // REST: GET /api/v1/file/get/<file_id>
        rpc GetFile(GetFileRequest) returns (stream FileChunk);

    // Move one or more files to another folder.
    // Validates all files and destination exist.
    // REST: POST /api/v1/file/mv
        rpc MoveFile(MoveFileRequest) returns (google.protobuf.Empty);

    // Convert files to documents and add to datasets.
    // Handles folders recursively (converts all inner files).
    // Links files to multiple datasets if multiple dataset_ids provided.
    // REST: POST /api/v1/file/convert
        rpc FileToDocument(FileToDocumentRequest) returns (FileToDocumentList);

    // ========================================================================
    // Dify Integration (1 method)
    // Integration with Dify platform.
    // REST: /api/v1/dify/retrieval
    // ========================================================================

    // Retrieve chunks in Dify-compatible format.
    // Uses API key authentication (not Bearer token).
    // REST: POST /api/v1/dify/retrieval
        rpc DifyRetrieval(DifyRetrievalRequest) returns (DifyRecordList);

    // ========================================================================
    // Bot API (11 methods)
    // Use API key authentication (not Bearer token).
    // REST: /api/v1/chatbots/*, /api/v1/agentbots/*, /api/v1/searchbots/*
    // ========================================================================

    // Ask a question across datasets without a chat assistant.
    // Streaming only. All datasets must have parsed files.
    // REST: POST /api/v1/sessions/ask
        rpc Ask(AskRequest) returns (stream AskResponse);

    // Generate related search terms for a question.
    // Returns 5-10 suggestions considering industry context.
    // REST: POST /api/v1/sessions/related_questions
        rpc RelatedQuestions(RelatedQuestionsRequest) returns (RelatedQuestionsResponse);

    // Chat completion for iframe/embedded chatbot (server streaming).
    // Uses API key from APIToken table.
    // REST: POST /api/v1/chatbots/<dialog_id>/completions
        rpc ChatbotCompletion(ChatbotCompletionRequest) returns (stream ChatCompletionResponse);

    // Get chatbot information for embedded UI initialization.
    // Returns title, avatar, and prologue.
    // REST: GET /api/v1/chatbots/<dialog_id>/info
        rpc ChatbotInfo(ChatbotInfoRequest) returns (ChatbotInfoResponse);

    // Agent completion for iframe/embedded agentbot (server streaming).
    // Uses API key authentication.
    // REST: POST /api/v1/agentbots/<agent_id>/completions
        rpc AgentbotCompletion(AgentbotCompletionRequest) returns (stream AgentCompletionResponse);

    // Get agent input form configuration for embedded UI.
    // Returns input schema from "begin" component in DSL.
    // REST: GET /api/v1/agentbots/<agent_id>/inputs
        rpc AgentbotInputs(AgentbotInputsRequest) returns (AgentbotInputsResponse);

    // Ask question in searchbot with search app configuration.
    // Uses search app config if provided.
    // REST: POST /api/v1/searchbots/ask
        rpc SearchbotAsk(SearchbotAskRequest) returns (stream AskResponse);

    // Test retrieval with searchbot configuration.
    // Supports search app configuration with auto metadata filtering.
    // REST: POST /api/v1/searchbots/retrieval_test
        rpc SearchbotRetrieval(SearchbotRetrievalRequest) returns (SearchbotRetrievalResponse);

    // Generate related questions for searchbot.
    // Uses search app LLM config if available.
    // REST: POST /api/v1/searchbots/related_questions
        rpc SearchbotRelatedQuestions(SearchbotRelatedQuestionsRequest) returns (RelatedQuestionsResponse);

    // Get search app configuration details.
    // Requires user to have access to search app.
    // REST: GET /api/v1/searchbots/detail
        rpc SearchbotDetail(SearchbotDetailRequest) returns (SearchbotDetailResponse);

    // Generate mindmap for a question.
    // Uses search app config if provided.
    // REST: POST /api/v1/searchbots/mindmap
        rpc SearchbotMindmap(SearchbotMindmapRequest) returns (google.protobuf.Struct);
}
